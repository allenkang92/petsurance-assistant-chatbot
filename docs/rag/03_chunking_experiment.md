# 청킹 전략 실험 결과
  
> **실험일**: 2025-12-25  
> **목표**: 펫보험 약관 데이터에 최적화된 청킹 전략 선정

---

## 1. 실험 배경

### 문제 정의
RAG 시스템의 검색 품질은 **텍스트 분할(Chunking) 전략**에 크게 의존.  
청크가 너무 크면 불필요한 정보가 포함되고, 너무 작으면 맥락이 손실.

### 데이터 특성
- **문서 수**: 122개 (펫보험 약관 마크다운)
- **구조**: `#### 제N조` 형태의 조항 기반 구조
- **언어**: 한국어

---

## 2. 실험 설계

### 실험 변수

| 변수 | 테스트 값 |
|:---|:---|
| 분할 방식 | Markdown / Recursive / Combined / Semantic |
| Chunk Size | 500 / 1000 |
| Chunk Overlap | 50 / 100 |

### 7가지 실험 조합

| ID | 전략 | 설명 |
|:---|:---|:---|
| A | MarkdownOnly | 마크다운 헤더(`#`, `##`, `###`, `####`) 기준 분할 |
| B | Recursive_500 | RecursiveCharacterTextSplitter (500자, 50 overlap) |
| C | Recursive_1000 | RecursiveCharacterTextSplitter (1000자, 100 overlap) |
| D | Combined_1000 | 마크다운 헤더 + Recursive (1000자) |
| E | Combined_500 | 마크다운 헤더 + Recursive (500자) |
| F | Semantic_percentile | SemanticChunker (percentile 95) |
| G | Semantic_gradient | SemanticChunker (gradient 95) |

### 평가 지표

| 지표 | 설명 |
|:---|:---|
| **청크 수** | 생성된 총 청크 개수 |
| **평균 길이** | 청크당 평균 글자 수 |
| **키워드 적중률** | Top-5 검색 결과에 예상 키워드 포함 비율 |
| **조항 인용률** | LLM 답변에 "제N조" 인용 여부 |

### 테스트 질문 (10개)

1. 슬개골 탈구 수술비가 보장되나요?
2. 면책 기간은 얼마인가요?
3. 노령견 가입 가능 나이는?
4. 보험금 청구 시 필요한 서류는?
5. 보상하지 않는 손해는?
6. 해약환급금은 얼마인가요?
7. 고관절 탈구도 보장되나요?
8. MRI 검사비 보장 한도는?
9. 치과 질환 보장 여부
10. 피부병 치료비 보장되나요?

---

## 3. 실험 결과

### 결과 요약

| 실험 | 청크 수 | 평균 길이 | 적중률 | 인용률 | 소요 시간 |
|:---|---:|---:|---:|---:|---:|
| **A. MarkdownOnly** | 15,021 | 842자 | **100%** | 0%* | 1.76초 |
| B. Recursive_500 | 31,362 | 418자 | **100%** | 0%* | 0.25초 |
| C. Recursive_1000 | 14,559 | 917자 | 98% | 0%* | 0.21초 |
| D. Combined_1000 | 23,261 | 570자 | 92% | 0%* | 2.25초 |
| E. Combined_500 | 35,656 | 367자 | 96% | 0%* | 1.84초 |
| F. Semantic_percentile | 6,395 | 1,962자 | 84% | 0%* | 652초 |
| G. Semantic_gradient | 6,409 | 1,958자 | 92% | 0%* | 702초 |

> *인용률 0%: Gemini API 할당량 초과로 LLM 답변 생성 실패

### 시각화

```
키워드 적중률 비교
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
A. MarkdownOnly     ████████████████████ 100%
B. Recursive_500    ████████████████████ 100%
C. Recursive_1000   ███████████████████░  98%
D. Combined_1000    ██████████████████░░  92%
E. Combined_500     ███████████████████░  96%
F. Semantic_pct     ████████████████░░░░  84%
G. Semantic_grad    ██████████████████░░  92%
```

---

## 4. 분석 및 인사이트

### 주요 발견

1. **마크다운 헤더 기반 분할이 가장 효과적**
   - 펫보험 약관의 `#### 제N조` 구조를 자연스럽게 보존
   - 키워드 적중률 100% 달성

2. **SemanticChunker는 비효율적**
   - 소요 시간이 10분 이상
   - 적중률도 84~92%로 상대적으로 낮음

3. **청크 크기와 적중률의 관계**
   - 500자 (작은 청크): 청크 수 증가, 검색 부담 증가
   - 1000자 (큰 청크): 맥락 보존, 효율적 검색

### 전략별 장단점

| 전략 | 장점 | 단점 |
|:---|:---|:---|
| **MarkdownOnly** | 구조 보존, 높은 적중률 | 긴 조항 처리 어려움 |
| **Recursive** | 균일한 청크, 빠른 처리 | 구조 무시 |
| **Combined** | 구조 + 크기 제어 | 복잡성 증가 |
| **Semantic** | 의미 단위 분할 | 느림, 구조 문서 부적합 |

---

## 5. 결론 및 권장 사항

### A. MarkdownOnly

```
선정 이유:
• 처리 속도 양호 (1.76초)
• 적절한 청크 수 (15,021개)
```

---

## 6. 실험 환경

| 항목 | 값 |
|:---|:---|
| 임베딩 모델 | `jhgan/ko-sroberta-multitask` (HuggingFace) |
| 벡터 스토어 | ChromaDB (로컬) |
| LLM | `gemini-2.0-flash` (답변 평가용) |
| 리트리버 | MMR (k=5, fetch_k=10) |

---
